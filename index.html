<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Corrida da Salvação - Joystick Só</title>
<style>
  body {
    margin: 0;
    background: black;
    overflow: hidden;
    font-family: Arial, sans-serif;
    touch-action: none;
  }
  canvas {
    display: block;
    margin: 0 auto;
    background: black;
    border: 2px solid #333;
  }
  #gameover {
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3em;
    color: red;
    display: none;
    z-index: 10;
  }
  #joystick-container {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 120px;
    height: 120px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    touch-action: none;
    z-index: 10;
  }
  #joystick {
    position: relative;
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    margin: 20px auto;
    touch-action: none;
  }
  #stick {
    position: absolute;
    width: 40px;
    height: 40px;
    background: rgba(255, 0, 0, 0.7);
    border-radius: 50%;
    top: 20px;
    left: 20px;
    touch-action: none;
  }
</style>
</head>
<body>
<canvas id="game" width="600" height="400"></canvas>
<div id="gameover">Fim de Jogo!</div>

<div id="joystick-container">
  <div id="joystick">
    <div id="stick"></div>
  </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const gravity = 0.8;
const groundLevel = 330;

let gameOver = false;

const player = {
  x: 50,
  y: groundLevel,
  w: 50,
  h: 70,
  velocityY: 0,
  isJumping: false,
  speedX: 5
};

const playerImg = new Image();
playerImg.src = "photo-output.png";

const knifeImg = new Image();
knifeImg.src = "https://i.ibb.co/2SZDcFz/knife.png";

const planeImg = new Image();
planeImg.src = "https://i.ibb.co/HCZ1M2H/plane.png";

let obstacles = [];

function createObstacle() {
  const types = [
    {img: knifeImg, w: 40, h: 20},
    {img: planeImg, w: 60, h: 30}
  ];
  const type = types[Math.floor(Math.random() * types.length)];
  const obstacle = {
    x: canvas.width + 50,
    y: groundLevel + 50 - type.h,
    w: type.w,
    h: type.h,
    img: type.img,
    speed: 6 + Math.random() * 3
  };
  obstacles.push(obstacle);
}

canvas.addEventListener("touchstart", (e) => {
  if (!player.isJumping) {
    player.velocityY = -15;
    player.isJumping = true;
  }
});

// Joystick virtual
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");

let dragging = false;
let maxDistance = 30;
let stickX = 0;

function getJoystickPos(touch) {
  const rect = joystick.getBoundingClientRect();
  let x = touch.clientX - rect.left - rect.width / 2;
  return x;
}

function onStart(e) {
  e.preventDefault();
  dragging = true;
  let x = e.touches ? getJoystickPos(e.touches[0]) : e.clientX;
  updateStick(x, 0);
}

function onMove(e) {
  if (!dragging) return;
  e.preventDefault();
  let x = e.touches ? getJoystickPos(e.touches[0]) : e.clientX;
  if (x > maxDistance) x = maxDistance;
  if (x < -maxDistance) x = -maxDistance;
  updateStick(x, 0);
}

function onEnd(e) {
  e.preventDefault();
  dragging = false;
  updateStick(0, 0);
}

function updateStick(x, y) {
  stick.style.transform = `translate(${x}px, ${y}px)`;
  stickX = x;
}

joystick.addEventListener("touchstart", onStart);
joystick.addEventListener("touchmove", onMove);
joystick.addEventListener("touchend", onEnd);
joystick.addEventListener("mousedown", onStart);
window.addEventListener("mousemove", onMove);
window.addEventListener("mouseup", onEnd);

function updatePlayer() {
  let joyX = stickX / maxDistance;
  if (Math.abs(joyX) > 0.1) {
    player.x += joyX * player.speedX;
  }
  if (player.x < 0) player.x = 0;
  if (player.x + player.w > canvas.width) player.x = canvas.width - player.w;

  player.velocityY += gravity;
  player.y += player.velocityY;

  if (player.y > groundLevel) {
    player.y = groundLevel;
    player.isJumping = false;
    player.velocityY = 0;
  }
}

function updateObstacles() {
  for (let i = obstacles.length - 1; i >= 0; i--) {
    const ob = obstacles[i];
    ob.x -= ob.speed;
    if (ob.x + ob.w < 0) obstacles.splice(i, 1);
  }
}

function detectCollision(rect1, rect2) {
  return (
    rect1.x < rect2.x + rect2.w &&
    rect1.x + rect1.w > rect2.x &&
    rect1.y < rect2.y + rect2.h &&
    rect1.y + rect1.h > rect2.y
  );
}

function checkCollisions() {
  for (const ob of obstacles) {
    if (detectCollision(player, ob)) {
      gameOver = true;
      document.getElementById("gameover").style.display = "block";
    }
  }
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // desenha o player
  ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);

  // desenha obstáculos
  for (const ob of obstacles) {
    ctx.drawImage(ob.img, ob.x, ob.y, ob.w, ob.h);
  }
}

let frameCount = 0;
function gameLoop() {
  if (gameOver) return;
  frameCount++;
  if (frameCount % 90 === 0) createObstacle();

  updatePlayer();
  updateObstacles();
  checkCollisions();
  draw();

  requestAnimationFrame(gameLoop);
}

playerImg.onload = () => {
  knifeImg.onload = () => {
    planeImg.onload = () => {
      gameLoop();
    };
  };
};
</script>
</body>
</html>