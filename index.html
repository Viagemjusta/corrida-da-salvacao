<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Corrida na Floresta</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }

    #joystickContainer, #jumpBtn {
      position: absolute; z-index: 2;
    }

    #joystickContainer {
      bottom: 40px; left: 40px;
      width: 120px; height: 120px;
    }

    #jumpBtn {
      bottom: 60px; right: 40px;
      width: 80px; height: 80px;
      border-radius: 50%;
      background: #44c767;
      border: none;
      color: white;
      font-size: 18px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="joystickContainer"></div>
  <button id="jumpBtn">PULAR</button>

  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>

  <script>
    let scene = new THREE.Scene();
    let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    let renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Luz
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(5, 10, 7);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x404040));

    // Chão com textura
    const floorTexture = new THREE.TextureLoader().load('https://i.ibb.co/hYK60k5/grass.jpg');
    floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping;
    floorTexture.repeat.set(20, 100);
    const floor = new THREE.Mesh(
      new THREE.PlaneGeometry(40, 1000),
      new THREE.MeshStandardMaterial({ map: floorTexture })
    );
    floor.rotation.x = -Math.PI / 2;
    scene.add(floor);

    // Jogador
    const playerTexture = new THREE.TextureLoader().load('https://i.ibb.co/j3bNC6P/character.png');
    const player = new THREE.Mesh(
      new THREE.BoxGeometry(1, 2, 1),
      new THREE.MeshStandardMaterial({ map: playerTexture })
    );
    player.position.set(0, 1, 0);
    scene.add(player);

    // Obstáculos
    let obstacles = [];

    function spawnObstacle() {
      const box = new THREE.Mesh(
        new THREE.BoxGeometry(1.5, 2, 1.5),
        new THREE.MeshStandardMaterial({ color: 0x8B0000 })
      );
      const lane = [-3, 0, 3][Math.floor(Math.random() * 3)];
      box.position.set(lane, 1, player.position.z - 50);
      scene.add(box);
      obstacles.push(box);
    }

    setInterval(spawnObstacle, 2000);

    // Câmera
    camera.position.set(0, 5, 8);
    camera.lookAt(player.position);

    // Joystick
    let moveX = 0;
    const joystick = nipplejs.create({
      zone: document.getElementById('joystickContainer'),
      mode: 'static',
      position: { left: '60px', bottom: '60px' },
      color: 'blue'
    });

    joystick.on('move', (evt, data) => {
      if (data && data.vector) {
        moveX = data.vector.x;
      }
    });
    joystick.on('end', () => {
      moveX = 0;
    });

    // Pular
    let isJumping = false;
    let jumpVelocity = 0;

    document.getElementById('jumpBtn').addEventListener('click', () => {
      if (!isJumping) {
        jumpVelocity = 0.15;
        isJumping = true;
      }
    });

    // Game Loop
    function animate() {
      requestAnimationFrame(animate);

      // Correr automático
      player.position.z -= 0.3;

      // Movimento lateral
      player.position.x += moveX * 0.5;
      if (player.position.x < -5) player.position.x = -5;
      if (player.position.x > 5) player.position.x = 5;

      // Pulo
      if (isJumping) {
        player.position.y += jumpVelocity;
        jumpVelocity -= 0.01;
        if (player.position.y <= 1) {
          player.position.y = 1;
          isJumping = false;
        }
      }

      // Mover obstáculos
      obstacles.forEach((obs, i) => {
        obs.position.z += 0.3;
        // Colisão
        if (obs.position.distanceTo(player.position) < 1.5) {
          alert("Você bateu!");
          window.location.reload();
        }
      });

      camera.position.z = player.position.z + 8;
      camera.lookAt(player.position);

      renderer.render(scene, camera);
    }

    animate();
  </script>
</body>
</html>